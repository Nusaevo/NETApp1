<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Number Input</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body>
    <div x-data="{
        rawValue: 4.00,
        displayValue: '',
        decimalPlaces: 2,

        formatNumber(num, showDecimals = false, applyRounding = false) {
            if (!num || num === '' || num === null || num === undefined) {
                return '';
            }
            // Convert to number and format with Indonesian style (dots for thousands, comma for decimals)
            let number = parseFloat(num);
            if (isNaN(number)) return '';

            // Apply decimal rounding only when explicitly requested (usually onBlur)
            if (applyRounding && this.decimalPlaces !== null) {
                number = parseFloat(number.toFixed(this.decimalPlaces));
            }

            // Format using Indonesian locale style
            let parts = number.toString().split('.');
            let integerPart = parseInt(parts[0]).toLocaleString('de-DE'); // Use German locale for dot separation
            let decimalPart = parts[1] || '';

            console.log('formatNumber:', {
                num,
                showDecimals,
                applyRounding,
                number,
                parts,
                integerPart,
                decimalPart,
                decimalPlaces: this.decimalPlaces
            });

            // Show decimals in several cases:
            // 1. If explicitly requested (user typed comma)
            // 2. If the number originally had decimals
            // 3. If decimalPlaces is set and > 0
            if (showDecimals || decimalPart) {
                if (this.decimalPlaces !== null && this.decimalPlaces > 0) {
                    // If decimalPlaces is defined, follow the rule
                    if (decimalPart === '') {
                        decimalPart = '0'.repeat(this.decimalPlaces);
                    } else if (applyRounding) {
                        // Only pad to exact decimal places when rounding (onBlur)
                        decimalPart = decimalPart.padEnd(this.decimalPlaces, '0').substring(0, this.decimalPlaces);
                    }
                    console.log('formatNumber returning with decimalPlaces:', integerPart + ',' + decimalPart);
                    return integerPart + ',' + decimalPart;
                } else if (decimalPart) {
                    // If no decimalPlaces defined but number has decimals, show as is
                    console.log('formatNumber returning without decimalPlaces:', integerPart + ',' + decimalPart);
                    return integerPart + ',' + decimalPart;
                } else if (showDecimals) {
                    // User typed comma but no decimalPlaces defined, show with minimal decimals
                    console.log('formatNumber returning minimal decimals:', integerPart + ',00');
                    return integerPart + ',00';
                }
            }

            console.log('formatNumber returning integer only:', integerPart);
            return integerPart;
        },

        updateDisplay() {
            // Check if rawValue has decimals or if current display has comma
            let hasDecimals = this.rawValue !== null && this.rawValue !== undefined &&
                            (this.rawValue.toString().includes('.') || this.rawValue % 1 !== 0);
            let hasComma = this.displayValue.includes(',');

            // ALWAYS show decimals if value has decimals OR user previously typed comma OR if rawValue is decimal
            let showDecimals = hasDecimals || hasComma || (this.rawValue && this.rawValue.toString().includes('.'));

            console.log('updateDisplay:', {
                rawValue: this.rawValue,
                hasDecimals,
                hasComma,
                showDecimals,
                currentDisplayValue: this.displayValue
            });

            this.displayValue = this.formatNumber(this.rawValue, showDecimals, false);

            console.log('updateDisplay result:', this.displayValue);
        }
    }"
    x-init="
        updateDisplay();
        $watch('rawValue', (value, oldValue) => {
            console.log('rawValue watcher triggered:', { value, oldValue });
            if (value !== oldValue) {
                updateDisplay();
                console.log('Updated display to:', displayValue);
            }
        });
    ">
        <h1>Debug Number Input</h1>

        <p>Current rawValue: <span x-text="rawValue"></span></p>
        <p>Current displayValue: <span x-text="displayValue"></span></p>

        <input type="text" x-model="displayValue" placeholder="Display Value">

        <br><br>

        <button @click="rawValue = 4.00; console.log('Set to 4.00');">Set to 4.00</button>
        <button @click="rawValue = 4.45; console.log('Set to 4.45');">Set to 4.45</button>
        <button @click="rawValue = 96038.44; console.log('Set to 96038.44');">Set to 96038.44</button>

        <br><br>

        <button @click="updateDisplay(); console.log('Manual updateDisplay called');">Manual Update Display</button>

        <p>Open browser console to see debug logs</p>
    </div>
</body>
</html>
